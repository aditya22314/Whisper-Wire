# Prisma & Database Guide

## 1. Files at a glance

| File | Role |
| --- | --- |
| `prisma/schema.prisma` | Source of truth for the database structure. Currently SQLite with a single `User` model. |
| `prisma/migrations/*` | SQL generated by `prisma migrate`. Keeps schema changes reproducible. |
| `prisma.config.ts` | Prisma 5+ configuration file. Loads environment variables (via `dotenv`) and forwards `DATABASE_URL` to the CLI/runtime. |
| `src/lib/prisma.ts` | Reusable `PrismaClient` singleton so the dev server doesn’t spawn multiple connections. |

## 2. Schema breakdown (`prisma/schema.prisma`)

```
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model User {
  id       String  @id @default(cuid())
  email    String? @unique
  name     String?
  image    String?
  password String?
}
```

- Uses SQLite stored in `dev.db` at the repo root. Swap to Postgres/MySQL by changing `provider` and `url` (or wiring `DATABASE_URL` through `prisma.config.ts`).
- `User` matches what NextAuth’s Prisma adapter expects (nullable password for OAuth-only users).

## 3. Prisma client singleton (`src/lib/prisma.ts`)

- Imports `PrismaClient` from `@prisma/client`.
- Instantiates it once per Node.js process and caches it on `globalThis` during development to avoid exhausting SQLite connections when Hot Reloading.
- Every server module (NextAuth route, future API handlers, server actions) should import the default export from here rather than calling `new PrismaClient()` directly.

## 4. How NextAuth uses Prisma

- `PrismaAdapter(prisma)` in `src/app/api/auth/[...nextauth]/route.ts` hooks NextAuth into the same client.
- When Google or credential sign-in succeeds, the adapter:
  1. Upserts the user in the `User` table.
  2. Persists sessions and verification tokens in the tables generated by Prisma’s migrations (add `Account`, `Session`, `VerificationToken` models when you expand the schema).

## 5. Typical workflows

### Bootstrap / regenerate

```bash
pnpm prisma migrate dev --name init   # updates dev.db and records migration
pnpm prisma generate                  # refreshes node_modules/.prisma
```

Run these after editing `schema.prisma`. The generate step also runs automatically after `migrate dev`.

### Inspect the database

```bash
pnpm prisma studio
```

Launches a browser UI to view tables, useful for verifying users/sessions created by NextAuth.

## 6. Environment variables

- `DATABASE_URL` should point at your target database. With SQLite you can hardcode `file:./dev.db`, but it’s still good practice to add it to `.env`.
- The `prisma.config.ts` guard throws if `DATABASE_URL` is missing, which prevents accidental deploys with undefined connections.

Armed with this overview you can grow the schema (add profiles, posts, etc.), switch databases, or debug adapter issues knowing exactly where Prisma fits into the application.***

